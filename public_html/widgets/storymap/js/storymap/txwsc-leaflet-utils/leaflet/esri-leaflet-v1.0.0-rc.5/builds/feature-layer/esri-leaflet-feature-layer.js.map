{"version":3,"file":"esri-leaflet-feature-layer.js","sources":["../../../src/EsriLeaflet.js","../../../src/Util.js","../../../src/Request.js","../../../src/Services/Service.js","../../../src/Services/FeatureLayer.js","../../../src/Tasks/Task.js","../../../src/Tasks/Query.js","../../../src/Layers/FeatureLayer/FeatureGrid.js","../../../src/Layers/FeatureLayer/FeatureManager.js","../../../src/Layers/FeatureLayer/FeatureLayer.js"],"names":["EsriLeaflet","VERSION","Layers","Services","Controls","Tasks","Util","Support","CORS","window","XMLHttpRequest","pointerEvents","document","documentElement","style","L","esri","clone","obj","target","i","hasOwnProperty","pointsEqual","a","b","length","closeRing","coordinates","push","ringIsClockwise","ringToTest","pt2","total","rLength","pt1","vertexIntersectsVertex","a1","a2","b1","b2","uaT","ubT","uB","ua","ub","arrayIntersectsArray","j","coordinatesContainPoint","point","contains","l","coordinatesContainCoordinates","outer","inner","intersects","convertRingsToGeoJSON","rings","x","outerRing","hole","outerRings","holes","r","ring","slice","polygon","uncontainedHoles","pop","contained","reverse","type","orientRings","poly","output","shift","flattenMultiPolygonRings","raf","requestAnimationFrame","webkitRequestAnimationFrame","mozRequestAnimationFrame","msRequestAnimationFrame","cb","setTimeout","extentToBounds","extent","sw","LatLng","ymin","xmin","ne","ymax","xmax","LatLngBounds","boundsToExtent","bounds","latLngBounds","getSouthWest","lng","lat","getNorthEast","spatialReference","wkid","arcgisToGeojson","arcgis","idAttribute","geojson","y","points","paths","geometry","attributes","properties","id","OBJECTID","FID","geojsonToArcGIS","result","features","geometries","responseToFeatureCollection","response","objectIdField","objectIdFieldName","fields","name","featureCollection","results","cleanUrl","url","replace","isArcgisOnline","test","geojsonTypeToArcGIS","geoJsonType","arcgisGeometryType","bind","serialize","params","data","f","key","value","param","Object","prototype","toString","call","JSON","stringify","join","valueOf","encodeURIComponent","createRequest","callback","context","httpRequest","onerror","error","code","message","onreadystatechange","readyState","parse","responseText","e","callbacks","_EsriLeafletCallbacks","Request","request","paramString","requestLength","open","send","setRequestHeader","get","JSONP","console","warn","post","XMLHTTP","callbackId","script","DomUtil","create","body","src","responseType","abort","_callback","Service","Class","extend","includes","Mixin","Events","options","proxy","useCors","initialize","this","_requestQueue","_authenticating","setOptions","path","_request","metadata","authenticate","token","_runQueue","method","fire","wrappedCallback","_createServiceCallback","apply","service","FeatureLayer","query","Query","addFeature","feature","addResults","undefined","updateFeature","updateResults","deleteFeature","objectIds","deleteResults","featureLayer","Task","generateSetter","endpoint","_service","setters","setter","offset","limit","precision","featureIds","returnGeometry","where","outSr","outFields","within","_setGeometry","spatialRel","overlaps","nearby","latlng","radius","latLng","geometryType","units","distance","inSr","string","between","start","end","time","simplify","map","factor","mapWidth","Math","abs","getBounds","getWest","getEast","maxAllowableOffset","getSize","orderBy","fieldName","order","orderByFields","run","_cleanParams","count","returnCountOnly","ids","returnIdsOnly","returnExtentOnly","pixelSize","layer","getLatLng","GeoJSON","getLayers","toGeoJSON","FeatureGrid","cellSize","updateInterval","onAdd","_map","_update","limitExecByInterval","addEventListener","getEvents","_reset","onRemove","removeEventListener","_removeCells","events","viewreset","moveend","zoomend","_onZoom","addTo","addLayer","removeFrom","removeLayer","zoom","getZoom","maxZoom","minZoom","hasLayer","_cells","_activeCells","_cellsToLoad","_cellsTotal","_resetWrap","crs","infinite","_getCellSize","wrapLng","_wrapLng","floor","project","ceil","wrapLat","_wrapLat","getPixelBounds","cellPadding","topLeft","min","subtract","divideBy","max","cellBounds","add","_removeOtherCells","_addCells","coords","queue","center","getCenter","Point","z","cellsToLoad","sort","distanceTo","_addCell","_cellCoordsToBounds","nwPoint","multiplyBy","sePoint","nw","unproject","wrap","se","_cellCoordsToKey","_keyToCellCoords","kArr","split","parseInt","_removeCell","cell","cellLeave","_wrapCoords","cellEnter","createCell","wrapNum","BinarySearchIndex","values","FeatureManager","from","to","timeField","timeFilterMode","simplifyFactor","oidCheck","match","on","_startTimeIndex","_endTimeIndex","_timeIndex","_cache","_currentSnapshot","_activeRequests","_pendingRequests","getAttribution","attribution","_requestFeatures","_buildQuery","exceededTransferLimit","_addFeatures","_cacheKey","_buildTimeIndexes","createLayers","setWhere","oldSnapshot","newShapshot","pendingRequests","requestError","requestCallback","removeLayers","addLayers","getWhere","getTimeRange","setTimeRange","oldFrom","oldTo","_filterExistingFeatures","refresh","newFrom","newTo","layersToRemove","_getFeaturesInTimeRange","layersToAdd","indexOf","shouldRemoveLayer","splice","search","startTimes","endTimes","concat","startTimeEntries","endTimeEntries","Date","bulkAdd","timeEntries","_featureWithinTimeRange","date","startDate","endDate","objectId","_query","currentIndex","currentElement","resultIndex","minIndex","maxIndex","round","dirty","startIndex","endIndex","items","statics","EVENTS","cacheLayers","_layers","_leafletIds","_key","random","_zooming","createNewLayer","geometryToLayer","pointToLayer","coordsToLatLng","newLayer","setLatLngs","updateGeo","getLatLngs","defaultOptions","_leaflet_id","_propagateEvent","_popup","bindPopup","_popupOptions","onEachFeature","resetStyle","permanent","cacheKey","cellKey","layers","mapBounds","removable","setFeatureStyle","setStyle","eachFeature","Path","fill","fn","popupContent","unbindPopup","groupLayers","gLayer","getFeature"],"mappings":"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","sourcesContent":["var EsriLeaflet = { //jshint ignore:line\n  VERSION: '1.0.0-rc.5',\n  Layers: {},\n  Services: {},\n  Controls: {},\n  Tasks: {},\n  Util: {},\n  Support: {\n    CORS: !!(window.XMLHttpRequest && 'withCredentials' in new XMLHttpRequest()),\n    pointerEvents: document.documentElement.style.pointerEvents === ''\n  }\n};\n\nif(typeof window !== 'undefined' && window.L){\n  window.L.esri = EsriLeaflet;\n}\n","(function(EsriLeaflet){\n\n  // normalize request animation frame\n  var raf = window.requestAnimationFrame ||\n     window.webkitRequestAnimationFrame ||\n     window.mozRequestAnimationFrame ||\n     window.msRequestAnimationFrame ||\n     function(cb) { return window.setTimeout(cb, 1000 / 60); };\n\n  // shallow object clone for feature properties and attributes\n  // from http://jsperf.com/cloning-an-object/2\n  function clone(obj) {\n    var target = {};\n    for (var i in obj) {\n      if (obj.hasOwnProperty(i)) {\n        target[i] = obj[i];\n      }\n    }\n    return target;\n  }\n\n  // checks if 2 x,y points are equal\n  function pointsEqual(a, b) {\n    for (var i = 0; i < a.length; i++) {\n      if (a[i] !== b[i]) {\n        return false;\n      }\n    }\n    return true;\n  }\n\n  // checks if the first and last points of a ring are equal and closes the ring\n  function closeRing(coordinates) {\n    if (!pointsEqual(coordinates[0], coordinates[coordinates.length - 1])) {\n      coordinates.push(coordinates[0]);\n    }\n    return coordinates;\n  }\n\n  // determine if polygon ring coordinates are clockwise. clockwise signifies outer ring, counter-clockwise an inner ring\n  // or hole. this logic was found at http://stackoverflow.com/questions/1165647/how-to-determine-if-a-list-of-polygon-\n  // points-are-in-clockwise-order\n  function ringIsClockwise(ringToTest) {\n    var total = 0,i = 0;\n    var rLength = ringToTest.length;\n    var pt1 = ringToTest[i];\n    var pt2;\n    for (i; i < rLength - 1; i++) {\n      pt2 = ringToTest[i + 1];\n      total += (pt2[0] - pt1[0]) * (pt2[1] + pt1[1]);\n      pt1 = pt2;\n    }\n    return (total >= 0);\n  }\n\n  // ported from terraformer.js https://github.com/Esri/Terraformer/blob/master/terraformer.js#L504-L519\n  function vertexIntersectsVertex(a1, a2, b1, b2) {\n    var uaT = (b2[0] - b1[0]) * (a1[1] - b1[1]) - (b2[1] - b1[1]) * (a1[0] - b1[0]);\n    var ubT = (a2[0] - a1[0]) * (a1[1] - b1[1]) - (a2[1] - a1[1]) * (a1[0] - b1[0]);\n    var uB  = (b2[1] - b1[1]) * (a2[0] - a1[0]) - (b2[0] - b1[0]) * (a2[1] - a1[1]);\n\n    if ( uB !== 0 ) {\n      var ua = uaT / uB;\n      var ub = ubT / uB;\n\n      if ( 0 <= ua && ua <= 1 && 0 <= ub && ub <= 1 ) {\n        return true;\n      }\n    }\n\n    return false;\n  }\n\n  // ported from terraformer.js https://github.com/Esri/Terraformer/blob/master/terraformer.js#L521-L531\n  function arrayIntersectsArray(a, b) {\n    for (var i = 0; i < a.length - 1; i++) {\n      for (var j = 0; j < b.length - 1; j++) {\n        if (vertexIntersectsVertex(a[i], a[i + 1], b[j], b[j + 1])) {\n          return true;\n        }\n      }\n    }\n\n    return false;\n  }\n\n  // ported from terraformer.js https://github.com/Esri/Terraformer/blob/master/terraformer.js#L470-L480\n  function coordinatesContainPoint(coordinates, point) {\n    var contains = false;\n    for(var i = -1, l = coordinates.length, j = l - 1; ++i < l; j = i) {\n      if (((coordinates[i][1] <= point[1] && point[1] < coordinates[j][1]) ||\n           (coordinates[j][1] <= point[1] && point[1] < coordinates[i][1])) &&\n          (point[0] < (coordinates[j][0] - coordinates[i][0]) * (point[1] - coordinates[i][1]) / (coordinates[j][1] - coordinates[i][1]) + coordinates[i][0])) {\n        contains = !contains;\n      }\n    }\n    return contains;\n  }\n\n  // ported from terraformer-arcgis-parser.js https://github.com/Esri/terraformer-arcgis-parser/blob/master/terraformer-arcgis-parser.js#L106-L113\n  function coordinatesContainCoordinates(outer, inner){\n    var intersects = arrayIntersectsArray(outer, inner);\n    var contains = coordinatesContainPoint(outer, inner[0]);\n    if(!intersects && contains){\n      return true;\n    }\n    return false;\n  }\n\n  // do any polygons in this array contain any other polygons in this array?\n  // used for checking for holes in arcgis rings\n  // ported from terraformer-arcgis-parser.js https://github.com/Esri/terraformer-arcgis-parser/blob/master/terraformer-arcgis-parser.js#L117-L172\n  function convertRingsToGeoJSON(rings){\n    var outerRings = [];\n    var holes = [];\n    var x; // iterator\n    var outerRing; // current outer ring being evaluated\n    var hole; // current hole being evaluated\n\n    // for each ring\n    for (var r = 0; r < rings.length; r++) {\n      var ring = closeRing(rings[r].slice(0));\n      if(ring.length < 4){\n        continue;\n      }\n      // is this ring an outer ring? is it clockwise?\n      if(ringIsClockwise(ring)){\n        var polygon = [ ring ];\n        outerRings.push(polygon); // push to outer rings\n      } else {\n        holes.push(ring); // counterclockwise push to holes\n      }\n    }\n\n    var uncontainedHoles = [];\n\n    // while there are holes left...\n    while(holes.length){\n      // pop a hole off out stack\n      hole = holes.pop();\n\n      // loop over all outer rings and see if they contain our hole.\n      var contained = false;\n      for (x = outerRings.length - 1; x >= 0; x--) {\n        outerRing = outerRings[x][0];\n        if(coordinatesContainCoordinates(outerRing, hole)){\n          // the hole is contained push it into our polygon\n          outerRings[x].push(hole);\n          contained = true;\n          break;\n        }\n      }\n\n      // ring is not contained in any outer ring\n      // sometimes this happens https://github.com/Esri/esri-leaflet/issues/320\n      if(!contained){\n        uncontainedHoles.push(hole);\n      }\n    }\n\n    // if we couldn't match any holes using contains we can try intersects...\n    while(uncontainedHoles.length){\n      // pop a hole off out stack\n      hole = uncontainedHoles.pop();\n\n      // loop over all outer rings and see if any intersect our hole.\n      var intersects = false;\n      for (x = outerRings.length - 1; x >= 0; x--) {\n        outerRing = outerRings[x][0];\n        if(arrayIntersectsArray(outerRing, hole)){\n          // the hole is contained push it into our polygon\n          outerRings[x].push(hole);\n          intersects = true;\n          break;\n        }\n      }\n\n      if(!intersects) {\n        outerRings.push([hole.reverse()]);\n      }\n    }\n\n    if(outerRings.length === 1){\n      return {\n        type: 'Polygon',\n        coordinates: outerRings[0]\n      };\n    } else {\n      return {\n        type: 'MultiPolygon',\n        coordinates: outerRings\n      };\n    }\n  }\n\n  // This function ensures that rings are oriented in the right directions\n  // outer rings are clockwise, holes are counterclockwise\n  // used for converting GeoJSON Polygons to ArcGIS Polygons\n  function orientRings(poly){\n    var output = [];\n    var polygon = poly.slice(0);\n    var outerRing = closeRing(polygon.shift().slice(0));\n    if(outerRing.length >= 4){\n      if(!ringIsClockwise(outerRing)){\n        outerRing.reverse();\n      }\n\n      output.push(outerRing);\n\n      for (var i = 0; i < polygon.length; i++) {\n        var hole = closeRing(polygon[i].slice(0));\n        if(hole.length >= 4){\n          if(ringIsClockwise(hole)){\n            hole.reverse();\n          }\n          output.push(hole);\n        }\n      }\n    }\n\n    return output;\n  }\n\n  // This function flattens holes in multipolygons to one array of polygons\n  // used for converting GeoJSON Polygons to ArcGIS Polygons\n  function flattenMultiPolygonRings(rings){\n    var output = [];\n    for (var i = 0; i < rings.length; i++) {\n      var polygon = orientRings(rings[i]);\n      for (var x = polygon.length - 1; x >= 0; x--) {\n        var ring = polygon[x].slice(0);\n        output.push(ring);\n      }\n    }\n    return output;\n  }\n\n  // convert an extent (ArcGIS) to LatLngBounds (Leaflet)\n  EsriLeaflet.Util.extentToBounds = function(extent){\n    var sw = new L.LatLng(extent.ymin, extent.xmin);\n    var ne = new L.LatLng(extent.ymax, extent.xmax);\n    return new L.LatLngBounds(sw, ne);\n  };\n\n  // convert an LatLngBounds (Leaflet) to extent (ArcGIS)\n  EsriLeaflet.Util.boundsToExtent = function(bounds) {\n    bounds = L.latLngBounds(bounds);\n    return {\n      'xmin': bounds.getSouthWest().lng,\n      'ymin': bounds.getSouthWest().lat,\n      'xmax': bounds.getNorthEast().lng,\n      'ymax': bounds.getNorthEast().lat,\n      'spatialReference': {\n        'wkid' : 4326\n      }\n    };\n  };\n\n  EsriLeaflet.Util.arcgisToGeojson = function (arcgis, idAttribute){\n    var geojson = {};\n\n    if(typeof arcgis.x === 'number' && typeof arcgis.y === 'number'){\n      geojson.type = 'Point';\n      geojson.coordinates = [arcgis.x, arcgis.y];\n    }\n\n    if(arcgis.points){\n      geojson.type = 'MultiPoint';\n      geojson.coordinates = arcgis.points.slice(0);\n    }\n\n    if(arcgis.paths) {\n      if(arcgis.paths.length === 1){\n        geojson.type = 'LineString';\n        geojson.coordinates = arcgis.paths[0].slice(0);\n      } else {\n        geojson.type = 'MultiLineString';\n        geojson.coordinates = arcgis.paths.slice(0);\n      }\n    }\n\n    if(arcgis.rings) {\n      geojson = convertRingsToGeoJSON(arcgis.rings.slice(0));\n    }\n\n    if(arcgis.geometry || arcgis.attributes) {\n      geojson.type = 'Feature';\n      geojson.geometry = (arcgis.geometry) ? EsriLeaflet.Util.arcgisToGeojson(arcgis.geometry) : null;\n      geojson.properties = (arcgis.attributes) ? clone(arcgis.attributes) : null;\n      if(arcgis.attributes) {\n        geojson.id =  arcgis.attributes[idAttribute] || arcgis.attributes.OBJECTID || arcgis.attributes.FID;\n      }\n    }\n\n    return geojson;\n  };\n\n  // GeoJSON -> ArcGIS\n  EsriLeaflet.Util.geojsonToArcGIS = function(geojson, idAttribute){\n    idAttribute = idAttribute || 'OBJECTID';\n    var spatialReference = { wkid: 4326 };\n    var result = {};\n    var i;\n\n    switch(geojson.type){\n    case 'Point':\n      result.x = geojson.coordinates[0];\n      result.y = geojson.coordinates[1];\n      result.spatialReference = spatialReference;\n      break;\n    case 'MultiPoint':\n      result.points = geojson.coordinates.slice(0);\n      result.spatialReference = spatialReference;\n      break;\n    case 'LineString':\n      result.paths = [geojson.coordinates.slice(0)];\n      result.spatialReference = spatialReference;\n      break;\n    case 'MultiLineString':\n      result.paths = geojson.coordinates.slice(0);\n      result.spatialReference = spatialReference;\n      break;\n    case 'Polygon':\n      result.rings = orientRings(geojson.coordinates.slice(0));\n      result.spatialReference = spatialReference;\n      break;\n    case 'MultiPolygon':\n      result.rings = flattenMultiPolygonRings(geojson.coordinates.slice(0));\n      result.spatialReference = spatialReference;\n      break;\n    case 'Feature':\n      if(geojson.geometry) {\n        result.geometry = EsriLeaflet.Util.geojsonToArcGIS(geojson.geometry, idAttribute);\n      }\n      result.attributes = (geojson.properties) ? clone(geojson.properties) : {};\n      if(geojson.id){\n        result.attributes[idAttribute] = geojson.id;\n      }\n      break;\n    case 'FeatureCollection':\n      result = [];\n      for (i = 0; i < geojson.features.length; i++){\n        result.push(EsriLeaflet.Util.geojsonToArcGIS(geojson.features[i], idAttribute));\n      }\n      break;\n    case 'GeometryCollection':\n      result = [];\n      for (i = 0; i < geojson.geometries.length; i++){\n        result.push(EsriLeaflet.Util.geojsonToArcGIS(geojson.geometries[i], idAttribute));\n      }\n      break;\n    }\n\n    return result;\n  };\n\n  EsriLeaflet.Util.responseToFeatureCollection = function(response, idAttribute){\n    var objectIdField;\n\n    if(idAttribute){\n      objectIdField = idAttribute;\n    } else if(response.objectIdFieldName){\n      objectIdField = response.objectIdFieldName;\n    } else if(response.fields) {\n      for (var j = 0; j <= response.fields.length - 1; j++) {\n        if(response.fields[j].type === 'esriFieldTypeOID') {\n          objectIdField = response.fields[j].name;\n          break;\n        }\n      }\n    } else {\n      objectIdField = 'OBJECTID';\n    }\n\n    var featureCollection = {\n      type: 'FeatureCollection',\n      features: []\n    };\n    var features = response.features || response.results;\n    if(features.length){\n      for (var i = features.length - 1; i >= 0; i--) {\n        featureCollection.features.push(EsriLeaflet.Util.arcgisToGeojson(features[i], objectIdField));\n      }\n    }\n\n    return featureCollection;\n  };\n\n    // trim whitespace and add a tailing slash is needed to a url\n  EsriLeaflet.Util.cleanUrl = function(url){\n    url = url.replace(/\\s\\s*/g, '');\n\n    //add a trailing slash to the url if the user omitted it\n    if(url[url.length-1] !== '/'){\n      url += '/';\n    }\n\n    return url;\n  };\n\n  EsriLeaflet.Util.isArcgisOnline = function(url){\n    return (/\\.arcgis\\.com/g).test(url);\n  };\n\n  EsriLeaflet.Util.geojsonTypeToArcGIS = function (geoJsonType) {\n    var arcgisGeometryType;\n    switch (geoJsonType) {\n    case 'Point':\n      arcgisGeometryType = 'esriGeometryPoint';\n      break;\n    case 'MultiPoint':\n      arcgisGeometryType = 'esriGeometryMultipoint';\n      break;\n    case 'LineString':\n      arcgisGeometryType = 'esriGeometryPolyline';\n      break;\n    case 'MultiLineString':\n      arcgisGeometryType = 'esriGeometryPolyline';\n      break;\n    case 'Polygon':\n      arcgisGeometryType = 'esriGeometryPolygon';\n      break;\n    case 'MultiPolygon':\n      arcgisGeometryType = 'esriGeometryPolygon';\n      break;\n    }\n    return arcgisGeometryType;\n  };\n\n  EsriLeaflet.Util.requestAnimationFrame = L.Util.bind(raf, window);\n\n})(EsriLeaflet);","(function(EsriLeaflet){\n\n  var callbacks = 0;\n\n  window._EsriLeafletCallbacks = {};\n\n  function serialize(params){\n    var data = '';\n\n    params.f = params.f || 'json';\n\n    for (var key in params){\n      if(params.hasOwnProperty(key)){\n        var param = params[key];\n        var type = Object.prototype.toString.call(param);\n        var value;\n\n        if(data.length){\n          data += '&';\n        }\n\n        if (type === '[object Array]'){\n          value = (Object.prototype.toString.call(param[0]) === '[object Object]') ? JSON.stringify(param) : param.join(',');\n        } else if (type === '[object Object]') {\n          value = JSON.stringify(param);\n        } else if (type === '[object Date]'){\n          value = param.valueOf();\n        } else {\n          value = param;\n        }\n\n        data += encodeURIComponent(key) + '=' + encodeURIComponent(value);\n      }\n    }\n\n    return data;\n  }\n\n  function createRequest(callback, context){\n    var httpRequest = new XMLHttpRequest();\n\n    httpRequest.onerror = function(e) {\n      callback.call(context, {\n        error: {\n          code: 500,\n          message: 'XMLHttpRequest error'\n        }\n      }, null);\n    };\n\n    httpRequest.onreadystatechange = function(){\n      var response;\n      var error;\n\n      if (httpRequest.readyState === 4) {\n        try {\n          response = JSON.parse(httpRequest.responseText);\n        } catch(e) {\n          response = null;\n          error = {\n            code: 500,\n            message: 'Could not parse response as JSON.'\n          };\n        }\n\n        if (!error && response.error) {\n          error = response.error;\n          response = null;\n        }\n\n        callback.call(context, error, response);\n      }\n    };\n\n    return httpRequest;\n  }\n\n  // AJAX handlers for CORS (modern browsers) or JSONP (older browsers)\n  EsriLeaflet.Request = {\n    request: function(url, params, callback, context){\n      var paramString = serialize(params);\n      var httpRequest = createRequest(callback, context);\n      var requestLength = (url + '?' + paramString).length;\n\n      // request is less then 2000 characters and the browser supports CORS, make GET request with XMLHttpRequest\n      if(requestLength <= 2000 && L.esri.Support.CORS){\n        httpRequest.open('GET', url + '?' + paramString);\n        httpRequest.send(null);\n\n      // request is less more then 2000 characters and the browser supports CORS, make POST request with XMLHttpRequest\n      } else if (requestLength > 2000 && L.esri.Support.CORS){\n        httpRequest.open('POST', url);\n        httpRequest.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');\n        httpRequest.send(paramString);\n\n      // request is less more then 2000 characters and the browser does not support CORS, make a JSONP request\n      } else if(requestLength <= 2000 && !L.esri.Support.CORS){\n        return L.esri.Request.get.JSONP(url, params, callback, context);\n\n      // request is longer then 2000 characters and the browser does not support CORS, log a warning\n      } else {\n        if(console && console.warn){\n          console.warn('a request to ' + url + ' was longer then 2000 characters and this browser cannot make a cross-domain post request. Please use a proxy http://esri.github.io/esri-leaflet/api-reference/request.html');\n          return;\n        }\n      }\n\n      return httpRequest;\n    },\n    post: {\n      XMLHTTP: function (url, params, callback, context) {\n        var httpRequest = createRequest(callback, context);\n        httpRequest.open('POST', url);\n        httpRequest.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');\n        httpRequest.send(serialize(params));\n\n        return httpRequest;\n      }\n    },\n\n    get: {\n      CORS: function (url, params, callback, context) {\n        var httpRequest = createRequest(callback, context);\n\n        httpRequest.open('GET', url + '?' + serialize(params), true);\n        httpRequest.send(null);\n\n        return httpRequest;\n      },\n      JSONP: function(url, params, callback, context){\n        var callbackId = 'c' + callbacks;\n\n        params.callback = 'window._EsriLeafletCallbacks.' + callbackId;\n\n        var script = L.DomUtil.create('script', null, document.body);\n        script.type = 'text/javascript';\n        script.src = url + '?' +  serialize(params);\n        script.id = callbackId;\n\n        window._EsriLeafletCallbacks[callbackId] = function(response){\n          if(window._EsriLeafletCallbacks[callbackId] !== true){\n            var error;\n            var responseType = Object.prototype.toString.call(response);\n\n            if(!(responseType === '[object Object]' || responseType === '[object Array]')){\n              error = {\n                error: {\n                  code: 500,\n                  message: 'Expected array or object as JSONP response'\n                }\n              };\n              response = null;\n            }\n\n            if (!error && response.error) {\n              error = response;\n              response = null;\n            }\n\n            callback.call(context, error, response);\n            window._EsriLeafletCallbacks[callbackId] = true;\n          }\n        };\n\n        callbacks++;\n\n        return {\n          id: callbackId,\n          url: script.src,\n          abort: function(){\n            window._EsriLeafletCallbacks._callback[callbackId]({\n              code: 0,\n              message: 'Request aborted.'\n            });\n          }\n        };\n      }\n    }\n  };\n\n  // choose the correct AJAX handler depending on CORS support\n  EsriLeaflet.get = (EsriLeaflet.Support.CORS) ? EsriLeaflet.Request.get.CORS : EsriLeaflet.Request.get.JSONP;\n\n  // always use XMLHttpRequest for posts\n  EsriLeaflet.post = EsriLeaflet.Request.post.XMLHTTP;\n\n  // expose a common request method the uses GET\\POST based on request length\n  EsriLeaflet.request = EsriLeaflet.Request.request;\n\n})(EsriLeaflet);","EsriLeaflet.Services.Service = L.Class.extend({\n\n  includes: L.Mixin.Events,\n\n  options: {\n    proxy: false,\n    useCors: EsriLeaflet.Support.CORS\n  },\n\n  initialize: function (options) {\n    options = options || {};\n    this._requestQueue = [];\n    this._authenticating = false;\n    L.Util.setOptions(this, options);\n    this.options.url = EsriLeaflet.Util.cleanUrl(this.options.url);\n  },\n\n  get: function (path, params, callback, context) {\n    return this._request('get', path, params, callback, context);\n  },\n\n  post: function (path, params, callback, context) {\n    return this._request('post', path, params, callback, context);\n  },\n\n  request: function (path, params, callback, context) {\n    return this._request('request', path, params, callback, context);\n  },\n\n  metadata: function (callback, context) {\n    return this._request('get', '', {}, callback, context);\n  },\n\n  authenticate: function(token){\n    this._authenticating = false;\n    this.options.token = token;\n    this._runQueue();\n    return this;\n  },\n\n  _request: function(method, path, params, callback, context){\n    this.fire('requeststart', {\n      url: this.options.url + path,\n      params: params,\n      method: method\n    });\n\n    var wrappedCallback = this._createServiceCallback(method, path, params, callback, context);\n\n    if (this.options.token) {\n      params.token = this.options.token;\n    }\n\n    if (this._authenticating) {\n      this._requestQueue.push([method, path, params, callback, context]);\n      return;\n    } else {\n      var url = (this.options.proxy) ? this.options.proxy + '?' + this.options.url + path : this.options.url + path;\n\n      if((method === 'get' || method === 'request') && !this.options.useCors){\n        return EsriLeaflet.Request.get.JSONP(url, params, wrappedCallback);\n      } else {\n        return EsriLeaflet[method](url, params, wrappedCallback);\n      }\n    }\n  },\n\n  _createServiceCallback: function(method, path, params, callback, context){\n    var request = [method, path, params, callback, context];\n\n    return L.Util.bind(function(error, response){\n\n      if (error && (error.code === 499 || error.code === 498)) {\n        this._authenticating = true;\n\n        this._requestQueue.push(request);\n\n        this.fire('authenticationrequired', {\n          authenticate: L.Util.bind(this.authenticate, this)\n        });\n      } else {\n        callback.call(context, error, response);\n\n        if(error) {\n          this.fire('requesterror', {\n            url: this.options.url + path,\n            params: params,\n            message: error.message,\n            code: error.code,\n            method: method\n          });\n        } else {\n          this.fire('requestsuccess', {\n            url: this.options.url + path,\n            params: params,\n            response: response,\n            method: method\n          });\n        }\n\n        this.fire('requestend', {\n          url: this.options.url + path,\n          params: params,\n          method: method\n        });\n      }\n    }, this);\n  },\n\n  _runQueue: function(){\n    for (var i = this._requestQueue.length - 1; i >= 0; i--) {\n      var request = this._requestQueue[i];\n      var method = request.shift();\n      this[method].apply(this, request);\n    }\n    this._requestQueue = [];\n  }\n\n});\n\nEsriLeaflet.Services.service = function(params){\n  return new EsriLeaflet.Services.Service(params);\n};","EsriLeaflet.Services.FeatureLayer = EsriLeaflet.Services.Service.extend({\n\n  options: {\n    idAttribute: 'OBJECTID'\n  },\n\n  query: function(){\n    return new EsriLeaflet.Tasks.Query(this);\n  },\n\n  addFeature: function(feature, callback, context) {\n    delete feature.id;\n\n    feature = EsriLeaflet.Util.geojsonToArcGIS(feature);\n\n    return this.post('addFeatures', {\n      features: [feature]\n    }, function(error, response){\n      var result = (response && response.addResults) ? response.addResults[0] : undefined;\n      if(callback){\n        callback.call(this, error || response.addResults[0].error, result);\n      }\n    }, context);\n  },\n\n  updateFeature: function(feature, callback, context) {\n    feature = EsriLeaflet.Util.geojsonToArcGIS(feature, this.options.idAttribute);\n\n    return this.post('updateFeatures', {\n      features: [feature]\n    }, function(error, response){\n      var result = (response && response.updateResults) ? response.updateResults[0] : undefined;\n      if(callback){\n        callback.call(context, error || response.updateResults[0].error, result);\n      }\n    }, context);\n  },\n\n  deleteFeature: function(id, callback, context) {\n    return this.post('deleteFeatures', {\n      objectIds: id\n    }, function(error, response){\n      var result = (response && response.deleteResults) ? response.deleteResults[0] : undefined;\n      if(callback){\n        callback.call(context, error || response.deleteResults[0].error, result);\n      }\n    }, context);\n  }\n\n});\n\nEsriLeaflet.Services.featureLayer = function(options) {\n  return new EsriLeaflet.Services.FeatureLayer(options);\n};","EsriLeaflet.Tasks.Task = L.Class.extend({\n\n  options: {\n    proxy: false,\n    useCors: EsriLeaflet.Support.CORS\n  },\n\n  //Generate a method for each methodName:paramName in the setters for this task.\n  generateSetter: function(param, context){\n    return L.Util.bind(function(value){\n      this.params[param] = value;\n      return this;\n    }, context);\n  },\n\n  initialize: function(endpoint){\n    // endpoint can be either a url (and options) for an ArcGIS Rest Service or an instance of EsriLeaflet.Service\n    if(endpoint.request && endpoint.options){\n      this._service = endpoint;\n      L.Util.setOptions(this, endpoint.options);\n    } else {\n      L.Util.setOptions(this, endpoint);\n      this.options.url = L.esri.Util.cleanUrl(endpoint.url);\n    }\n\n    // clone default params into this object\n    this.params = L.Util.extend({}, this.params || {});\n\n    // generate setter methods based on the setters object implimented a child class\n    if(this.setters){\n      for (var setter in this.setters){\n        var param = this.setters[setter];\n        this[setter] = this.generateSetter(param, this);\n      }\n    }\n  },\n\n  token: function(token){\n    if(this._service){\n      this._service.authenticate(token);\n    } else {\n      this.params.token = token;\n    }\n    return this;\n  },\n\n  request: function(callback, context){\n    if(this._service){\n      return this._service.request(this.path, this.params, callback, context);\n    } else {\n      return this._request('request', this.path, this.params, callback, context);\n    }\n  },\n\n  _request: function(method, path, params, callback, context){\n    var url = (this.options.proxy) ? this.options.proxy + '?' + this.options.url + path : this.options.url + path;\n    if((method === 'get' || method === 'request') && !this.options.useCors){\n      return EsriLeaflet.Request.get.JSONP(url, params, callback, context);\n    } else{\n      return EsriLeaflet[method](url, params, callback, context);\n    }\n  }\n});","EsriLeaflet.Tasks.Query = EsriLeaflet.Tasks.Task.extend({\n  setters: {\n    'offset': 'offset',\n    'limit': 'limit',\n    'fields': 'outFields',\n    'precision': 'geometryPrecision',\n    'featureIds': 'objectIds',\n    'returnGeometry': 'returnGeometry',\n    'token': 'token'\n  },\n\n  path: 'query',\n\n  params: {\n    returnGeometry: true,\n    where: '1=1',\n    outSr: 4326,\n    outFields: '*'\n  },\n\n  within: function(geometry){\n    this._setGeometry(geometry);\n    this.params.spatialRel = 'esriSpatialRelContains'; // will make code read layer within geometry, to the api this will reads geometry contains layer\n    return this;\n  },\n\n  intersects: function(geometry){\n    this._setGeometry(geometry);\n    this.params.spatialRel = 'esriSpatialRelIntersects';\n    return this;\n  },\n\n  contains: function(geometry){\n    this._setGeometry(geometry);\n    this.params.spatialRel = 'esriSpatialRelWithin'; // will make code read layer contains geometry, to the api this will reads geometry within layer\n    return this;\n  },\n\n  // crosses: function(geometry){\n  //   this._setGeometry(geometry);\n  //   this.params.spatialRel = 'esriSpatialRelCrosses';\n  //   return this;\n  // },\n\n  // touches: function(geometry){\n  //   this._setGeometry(geometry);\n  //   this.params.spatialRel = 'esriSpatialRelTouches';\n  //   return this;\n  // },\n\n  overlaps: function(geometry){\n    this._setGeometry(geometry);\n    this.params.spatialRel = 'esriSpatialRelOverlaps';\n    return this;\n  },\n\n  // only valid for Feature Services running on ArcGIS Server 10.3 or ArcGIS Online\n  nearby: function(latlng, radius){\n    latlng = L.latLng(latlng);\n    this.params.geometry = [latlng.lng, latlng.lat];\n    this.params.geometryType = 'esriGeometryPoint';\n    this.params.spatialRel = 'esriSpatialRelIntersects';\n    this.params.units = 'esriSRUnit_Meter';\n    this.params.distance = radius;\n    this.params.inSr = 4326;\n    return this;\n  },\n\n  where: function(string){\n    this.params.where = string.replace(/\"/g, \"\\'\"); // jshint ignore:line\n    return this;\n  },\n\n  between: function(start, end){\n    this.params.time = [start.valueOf(), end.valueOf()];\n    return this;\n  },\n\n  simplify: function(map, factor){\n    var mapWidth = Math.abs(map.getBounds().getWest() - map.getBounds().getEast());\n    this.params.maxAllowableOffset = (mapWidth / map.getSize().y) * factor;\n    return this;\n  },\n\n  orderBy: function(fieldName, order){\n    order = order || 'ASC';\n    this.params.orderByFields = (this.params.orderByFields) ? this.params.orderByFields + ',' : '';\n    this.params.orderByFields += ([fieldName, order]).join(' ');\n    return this;\n  },\n\n  run: function(callback, context){\n    this._cleanParams();\n\n    // if the service is hosted on arcgis online request geojson directly\n    if(EsriLeaflet.Util.isArcgisOnline(this.options.url)){\n      this.params.f = 'geojson';\n\n      return this.request(function(error, response){\n        callback.call(context, error, response, response);\n      }, context);\n\n    // otherwise convert it in the callback then pass it on\n    } else {\n      return this.request(function(error, response){\n        callback.call(context, error, (response && EsriLeaflet.Util.responseToFeatureCollection(response)), response);\n      }, context);\n    }\n  },\n\n  count: function(callback, context){\n    this._cleanParams();\n    this.params.returnCountOnly = true;\n    return this.request(function(error, response){\n      callback.call(this, error, (response && response.count), response);\n    }, context);\n  },\n\n  ids: function(callback, context){\n    this._cleanParams();\n    this.params.returnIdsOnly = true;\n    return this.request(function(error, response){\n      callback.call(this, error, (response && response.objectIds), response);\n    }, context);\n  },\n\n  // only valid for Feature Services running on ArcGIS Server 10.3 or ArcGIS Online\n  bounds: function(callback, context){\n    this._cleanParams();\n    this.params.returnExtentOnly = true;\n    return this.request(function(error, response){\n      callback.call(context, error, (response && response.extent && EsriLeaflet.Util.extentToBounds(response.extent)), response);\n    }, context);\n  },\n\n  // only valid for image services\n  pixelSize: function(point){\n    point = L.point(point);\n    this.params.pixelSize = [point.x,point.y];\n    return this;\n  },\n\n  // only valid for map services\n  layer: function(layer){\n    this.path = layer + '/query';\n    return this;\n  },\n\n  _cleanParams: function(){\n    delete this.params.returnIdsOnly;\n    delete this.params.returnExtentOnly;\n    delete this.params.returnCountOnly;\n  },\n\n  _setGeometry: function(geometry) {\n    this.params.inSr = 4326;\n\n    // convert bounds to extent and finish\n    if ( geometry instanceof L.LatLngBounds ) {\n      // set geometry + geometryType\n      this.params.geometry = EsriLeaflet.Util.boundsToExtent(geometry);\n      this.params.geometryType = 'esriGeometryEnvelope';\n      return;\n    }\n\n    // convert L.Marker > L.LatLng\n    if(geometry.getLatLng){\n      geometry = geometry.getLatLng();\n    }\n\n    // convert L.LatLng to a geojson point and continue;\n    if (geometry instanceof L.LatLng) {\n      geometry = {\n        type: 'Point',\n        coordinates: [geometry.lng, geometry.lat]\n      };\n    }\n\n    // handle L.GeoJSON, pull out the first geometry\n    if ( geometry instanceof L.GeoJSON ) {\n      //reassign geometry to the GeoJSON value  (we are assuming that only one feature is present)\n      geometry = geometry.getLayers()[0].feature.geometry;\n      this.params.geometry = EsriLeaflet.Util.geojsonToArcGIS(geometry);\n      this.params.geometryType = EsriLeaflet.Util.geojsonTypeToArcGIS(geometry.type);\n    }\n\n    // Handle L.Polyline and L.Polygon\n    if (geometry.toGeoJSON) {\n      geometry = geometry.toGeoJSON();\n    }\n\n    // handle GeoJSON feature by pulling out the geometry\n    if ( geometry.type === 'Feature' ) {\n      // get the geometry of the geojson feature\n      geometry = geometry.geometry;\n    }\n\n    // confirm that our GeoJSON is a point, line or polygon\n    if ( geometry.type === 'Point' ||  geometry.type === 'LineString' || geometry.type === 'Polygon') {\n      this.params.geometry = EsriLeaflet.Util.geojsonToArcGIS(geometry);\n      this.params.geometryType = EsriLeaflet.Util.geojsonTypeToArcGIS(geometry.type);\n      return;\n    }\n\n    // warn the user if we havn't found a\n    /* global console */\n    if(console && console.warn) {\n      console.warn('invalid geometry passed to spatial query. Should be an L.LatLng, L.LatLngBounds or L.Marker or a GeoJSON Point Line or Polygon object');\n    }\n\n    return;\n  }\n});\n\nEsriLeaflet.Tasks.query = function(params){\n  return new EsriLeaflet.Tasks.Query(params);\n};","EsriLeaflet.Layers.FeatureGrid = L.Class.extend({\n\n  includes: L.Mixin.Events,\n\n  options: {\n    cellSize: 512,\n    updateInterval: 150\n  },\n\n  initialize: function (options) {\n    options = L.setOptions(this, options);\n  },\n\n  onAdd: function (map) {\n    this._map = map;\n    this._update = L.Util.limitExecByInterval(this._update, this.options.updateInterval, this);\n\n    // @TODO remove for leaflet 0.8\n    this._map.addEventListener(this.getEvents(), this);\n\n    this._reset();\n    this._update();\n  },\n\n  onRemove: function(){\n    this._map.removeEventListener(this.getEvents(), this);\n    this._removeCells();\n  },\n\n  getEvents: function () {\n    var events = {\n      viewreset: this._reset,\n      moveend: this._update,\n      zoomend : this._onZoom\n    };\n\n    return events;\n  },\n\n  addTo: function(map){\n    map.addLayer(this);\n    return this;\n  },\n\n  removeFrom: function(map){\n    map.removeLayer(this);\n    return this;\n  },\n\n  _onZoom : function () {\n    var zoom = this._map.getZoom();\n\n    if (zoom > this.options.maxZoom ||\n        zoom < this.options.minZoom) {\n      this.removeFrom(this._map);\n      this._map.addEventListener('zoomend', this.getEvents().zoomend, this);\n    } else if (!this._map.hasLayer(this)) {\n      this._map.removeEventListener('zoomend', this.getEvents().zoomend, this);\n      this.addTo(this._map);\n    }\n\n  },\n\n  _reset: function () {\n    this._removeCells();\n\n    this._cells = {};\n    this._activeCells = {};\n    this._cellsToLoad = 0;\n    this._cellsTotal = 0;\n\n    // @TODO enable at Leaflet 0.8\n    // this._cellNumBounds = this._getCellNumBounds();\n\n    this._resetWrap();\n  },\n\n  _resetWrap: function () {\n    var map = this._map,\n        crs = map.options.crs;\n\n    if (crs.infinite) { return; }\n\n    var cellSize = this._getCellSize();\n\n    if (crs.wrapLng) {\n      this._wrapLng = [\n        Math.floor(map.project([0, crs.wrapLng[0]]).x / cellSize),\n        Math.ceil(map.project([0, crs.wrapLng[1]]).x / cellSize)\n      ];\n    }\n\n    if (crs.wrapLat) {\n      this._wrapLat = [\n        Math.floor(map.project([crs.wrapLat[0], 0]).y / cellSize),\n        Math.ceil(map.project([crs.wrapLat[1], 0]).y / cellSize)\n      ];\n    }\n  },\n\n  _getCellSize: function () {\n    return this.options.cellSize;\n  },\n\n  _update: function () {\n    if (!this._map) { return; }\n\n    var bounds = this._map.getPixelBounds(),\n        zoom = this._map.getZoom(),\n        cellSize = this._getCellSize(),\n        cellPadding = [cellSize/2,cellSize/2];\n        // cellPadding = [0,0]\n\n    if (zoom > this.options.maxZoom ||\n        zoom < this.options.minZoom) { return; }\n\n    // cell coordinates range for the current view\n    var topLeft = bounds.min.subtract(cellPadding).divideBy(cellSize).floor();\n    topLeft.x = Math.max(topLeft.x, 0);\n    topLeft.y = Math.max(topLeft.y, 0);\n\n    var cellBounds = L.bounds(topLeft, bounds.max.add(cellPadding).divideBy(cellSize).floor());\n\n    // remove any present cells that are off the specified bounds\n    this._removeOtherCells(cellBounds);\n    this._addCells(cellBounds);\n  },\n\n  _addCells: function (bounds) {\n    var queue = [],\n        center = bounds.getCenter(),\n        zoom = this._map.getZoom();\n\n    var j, i, coords;\n    // create a queue of coordinates to load cells from\n    for (j = bounds.min.y; j <= bounds.max.y; j++) {\n      for (i = bounds.min.x; i <= bounds.max.x; i++) {\n        coords = new L.Point(i, j);\n        coords.z = zoom;\n\n        // @TODO enable at Leaflet 0.8\n        // if (this._isValidCell(coords)) {\n        //   queue.push(coords);\n        // }\n\n        queue.push(coords);\n      }\n    }\n    var cellsToLoad = queue.length;\n\n    if (cellsToLoad === 0) { return; }\n\n    this._cellsToLoad += cellsToLoad;\n    this._cellsTotal += cellsToLoad;\n\n    // sort cell queue to load cells in order of their distance to center\n    queue.sort(function (a, b) {\n      return a.distanceTo(center) - b.distanceTo(center);\n    });\n\n    for (i = 0; i < cellsToLoad; i++) {\n      this._addCell(queue[i]);\n    }\n  },\n\n  // @TODO enable at Leaflet 0.8\n  // _isValidCell: function (coords) {\n  //   var crs = this._map.options.crs;\n\n  //   if (!crs.infinite) {\n  //     // don't load cell if it's out of bounds and not wrapped\n  //     var bounds = this._cellNumBounds;\n  //     if (\n  //       (!crs.wrapLng && (coords.x < bounds.min.x || coords.x > bounds.max.x)) ||\n  //       (!crs.wrapLat && (coords.y < bounds.min.y || coords.y > bounds.max.y))\n  //     ) {\n  //       return false;\n  //     }\n  //   }\n\n  //   if (!this.options.bounds) {\n  //     return true;\n  //   }\n\n  //   // don't load cell if it doesn't intersect the bounds in options\n  //   var cellBounds = this._cellCoordsToBounds(coords);\n  //   return L.latLngBounds(this.options.bounds).intersects(cellBounds);\n  // },\n\n  // converts cell coordinates to its geographical bounds\n  _cellCoordsToBounds: function (coords) {\n    var map = this._map,\n        cellSize = this.options.cellSize,\n\n        nwPoint = coords.multiplyBy(cellSize),\n        sePoint = nwPoint.add([cellSize, cellSize]),\n\n        // @TODO for Leaflet 0.8\n        // nw = map.wrapLatLng(map.unproject(nwPoint, coords.z)),\n        // se = map.wrapLatLng(map.unproject(sePoint, coords.z));\n\n        nw = map.unproject(nwPoint, coords.z).wrap(),\n        se = map.unproject(sePoint, coords.z).wrap();\n\n    return new L.LatLngBounds(nw, se);\n  },\n\n  // converts cell coordinates to key for the cell cache\n  _cellCoordsToKey: function (coords) {\n    return coords.x + ':' + coords.y;\n  },\n\n  // converts cell cache key to coordiantes\n  _keyToCellCoords: function (key) {\n    var kArr = key.split(':'),\n        x = parseInt(kArr[0], 10),\n        y = parseInt(kArr[1], 10);\n\n    return new L.Point(x, y);\n  },\n\n  // remove any present cells that are off the specified bounds\n  _removeOtherCells: function (bounds) {\n    for (var key in this._cells) {\n      if (!bounds.contains(this._keyToCellCoords(key))) {\n        this._removeCell(key);\n      }\n    }\n  },\n\n  _removeCell: function (key) {\n    var cell = this._activeCells[key];\n    if(cell){\n      delete this._activeCells[key];\n\n      if (this.cellLeave) {\n        this.cellLeave(cell.bounds, cell.coords);\n      }\n\n      this.fire('cellleave', {\n        bounds: cell.bounds,\n        coords: cell.coords\n      });\n    }\n  },\n\n  _removeCells: function(){\n    for (var key in this._cells) {\n      var bounds = this._cells[key].bounds;\n      var coords = this._cells[key].coords;\n\n      if (this.cellLeave) {\n        this.cellLeave(bounds, coords);\n      }\n\n      this.fire('cellleave', {\n        bounds: bounds,\n        coords: coords\n      });\n    }\n  },\n\n  _addCell: function (coords) {\n\n    // wrap cell coords if necessary (depending on CRS)\n    this._wrapCoords(coords);\n\n    // generate the cell key\n    var key = this._cellCoordsToKey(coords);\n\n    // get the cell from the cache\n    var cell = this._cells[key];\n    // if this cell should be shown as isnt active yet (enter)\n\n    if (cell && !this._activeCells[key]) {\n      if (this.cellEnter) {\n        this.cellEnter(cell.bounds, coords);\n      }\n\n      this.fire('cellenter', {\n        bounds: cell.bounds,\n        coords: coords\n      });\n\n      this._activeCells[key] = cell;\n    }\n\n    // if we dont have this cell in the cache yet (create)\n    if (!cell) {\n      cell = {\n        coords: coords,\n        bounds: this._cellCoordsToBounds(coords)\n      };\n\n      this._cells[key] = cell;\n      this._activeCells[key] = cell;\n\n      if(this.createCell){\n        this.createCell(cell.bounds, coords);\n      }\n\n      this.fire('cellcreate', {\n        bounds: cell.bounds,\n        coords: coords\n      });\n    }\n  },\n\n  _wrapCoords: function (coords) {\n    coords.x = this._wrapLng ? L.Util.wrapNum(coords.x, this._wrapLng) : coords.x;\n    coords.y = this._wrapLat ? L.Util.wrapNum(coords.y, this._wrapLat) : coords.y;\n  }\n\n  // get the global cell coordinates range for the current zoom\n  // @TODO enable at Leaflet 0.8\n  // _getCellNumBounds: function () {\n  //   // @TODO for Leaflet 0.8\n  //   // var bounds = this._map.getPixelWorldBounds(),\n  //   //     size = this._getCellSize();\n  //   //\n  //   // return bounds ? L.bounds(\n  //   //     bounds.min.divideBy(size).floor(),\n  //   //     bounds.max.divideBy(size).ceil().subtract([1, 1])) : null;\n  // }\n\n});","(function(EsriLeaflet){\n\n  EsriLeaflet.Layers.FeatureManager = EsriLeaflet.Layers.FeatureGrid.extend({\n\n    /**\n     * Options\n     */\n\n    options: {\n      where: '1=1',\n      fields: ['*'],\n      from: false,\n      to: false,\n      timeField: false,\n      timeFilterMode: 'server',\n      simplifyFactor: 0,\n      precision: 6\n    },\n\n    /**\n     * Constructor\n     */\n\n    initialize: function (url, options) {\n      EsriLeaflet.Layers.FeatureGrid.prototype.initialize.call(this, options);\n\n      options = options || {};\n      options.url = EsriLeaflet.Util.cleanUrl(url);\n      options = L.setOptions(this, options);\n\n      this._service = new EsriLeaflet.Services.FeatureLayer(options);\n\n      //use case insensitive regex to look for common fieldnames used for indexing\n      /*global console */\n      if (this.options.fields[0] !== '*'){\n        var oidCheck = false;\n        for (var i = 0; i < this.options.fields.length; i++){\n          if (this.options.fields[i].match(/^(OBJECTID|FID|OID|ID)$/i)){\n            oidCheck = true;\n          }\n        }\n        if (oidCheck === false && console && console.warn){\n          console.warn('no known esriFieldTypeOID field detected in fields Array.  Please add an attribute field containing unique IDs to ensure the layer can be drawn correctly.');\n        }\n      }\n\n      // Leaflet 0.8 change to new propagation\n      this._service.on('authenticationrequired requeststart requestend requesterror requestsuccess', function (e) {\n        e = L.extend({\n          target: this\n        }, e);\n        this.fire(e.type, e);\n      }, this);\n\n      if(this.options.timeField.start && this.options.timeField.end){\n        this._startTimeIndex = new BinarySearchIndex();\n        this._endTimeIndex = new BinarySearchIndex();\n      } else if(this.options.timeField){\n        this._timeIndex = new BinarySearchIndex();\n      }\n\n      this._cache = {};\n      this._currentSnapshot = []; // cache of what layers should be active\n      this._activeRequests = 0;\n      this._pendingRequests = [];\n    },\n\n    /**\n     * Layer Interface\n     */\n\n    onAdd: function(map){\n      return EsriLeaflet.Layers.FeatureGrid.prototype.onAdd.call(this, map);\n    },\n\n    onRemove: function(map){\n      return EsriLeaflet.Layers.FeatureGrid.prototype.onRemove.call(this, map);\n    },\n\n    getAttribution: function () {\n      return this.options.attribution;\n    },\n\n    /**\n     * Feature Managment\n     */\n\n    createCell: function(bounds, coords){\n      this._requestFeatures(bounds, coords);\n    },\n\n    _requestFeatures: function(bounds, coords, callback){\n      this._activeRequests++;\n\n      // our first active request fires loading\n      if(this._activeRequests === 1){\n        this.fire('loading', {\n          bounds: bounds\n        });\n      }\n\n      return this._buildQuery(bounds).run(function(error, featureCollection, response){\n        if(response && response.exceededTransferLimit){\n          this.fire('drawlimitexceeded');\n        }\n\n        //deincriment the request counter\n        this._activeRequests--;\n\n        if(!error && featureCollection.features.length){\n          // schedule adding features until the next animation frame\n          EsriLeaflet.Util.requestAnimationFrame(L.Util.bind(function(){\n            this._addFeatures(featureCollection.features, coords);\n          }, this));\n        }\n\n        if(callback){\n          callback.call(this, error, featureCollection);\n        }\n\n        // if there are no more active requests fire a load event for this view\n        if(this._activeRequests <= 0){\n          this.fire('load', {\n            bounds: bounds\n          });\n        }\n      }, this);\n    },\n\n    _cacheKey: function (coords){\n      return coords.z + ':' + coords.x + ':' +coords.y;\n    },\n\n    _addFeatures: function(features, coords){\n      var key = this._cacheKey(coords);\n      this._cache[key] = this._cache[key] || [];\n\n      for (var i = features.length - 1; i >= 0; i--) {\n        var id = features[i].id;\n        this._currentSnapshot.push(id);\n        this._cache[key].push(id);\n      }\n\n      if(this.options.timeField){\n        this._buildTimeIndexes(features);\n      }\n\n      var zoom = this._map.getZoom();\n\n      if (zoom > this.options.maxZoom ||\n          zoom < this.options.minZoom) { return; }\n\n      this.createLayers(features);\n    },\n\n    _buildQuery: function(bounds){\n      var query = this._service.query().intersects(bounds).where(this.options.where).fields(this.options.fields).precision(this.options.precision);\n\n      if(this.options.simplifyFactor){\n        query.simplify(this._map, this.options.simplifyFactor);\n      }\n\n      if(this.options.timeFilterMode === 'server' && this.options.from && this.options.to){\n        query.between(this.options.from, this.options.to);\n      }\n\n      return query;\n    },\n\n    /**\n     * Where Methods\n     */\n\n    setWhere: function(where, callback, context){\n\n      this.options.where = (where && where.length) ? where : '1=1';\n\n      var oldSnapshot = [];\n      var newShapshot = [];\n      var pendingRequests = 0;\n      var requestError = null;\n      var requestCallback = L.Util.bind(function(error, featureCollection){\n        if(error){\n          requestError = error;\n        }\n\n        if(featureCollection){\n          for (var i = featureCollection.features.length - 1; i >= 0; i--) {\n            newShapshot.push(featureCollection.features[i].id);\n          }\n        }\n\n        pendingRequests--;\n\n        if(pendingRequests <= 0){\n          this._currentSnapshot = newShapshot;\n          // schedule adding features until the next animation frame\n          EsriLeaflet.Util.requestAnimationFrame(L.Util.bind(function(){\n            this.removeLayers(oldSnapshot);\n            this.addLayers(newShapshot);\n            if(callback) {\n              callback.call(context, requestError);\n            }\n          }, this));\n\n        }\n      }, this);\n\n      for (var i = this._currentSnapshot.length - 1; i >= 0; i--) {\n        oldSnapshot.push(this._currentSnapshot[i]);\n      }\n\n      for(var key in this._activeCells){\n        pendingRequests++;\n        var coords = this._keyToCellCoords(key);\n        var bounds = this._cellCoordsToBounds(coords);\n        this._requestFeatures(bounds, key, requestCallback);\n      }\n\n      return this;\n    },\n\n    getWhere: function(){\n      return this.options.where;\n    },\n\n    /**\n     * Time Range Methods\n     */\n\n    getTimeRange: function(){\n      return [this.options.from, this.options.to];\n    },\n\n    setTimeRange: function(from, to, callback, context){\n      var oldFrom = this.options.from;\n      var oldTo = this.options.to;\n      var pendingRequests = 0;\n      var requestError = null;\n      var requestCallback = L.Util.bind(function(error){\n        if(error){\n          requestError = error;\n        }\n        this._filterExistingFeatures(oldFrom, oldTo, from, to);\n\n        pendingRequests--;\n\n        if(callback && pendingRequests <= 0){\n          callback.call(context, requestError);\n        }\n      }, this);\n\n      this.options.from = from;\n      this.options.to = to;\n\n      this._filterExistingFeatures(oldFrom, oldTo, from, to);\n\n      if(this.options.timeFilterMode === 'server') {\n        for(var key in this._activeCells){\n          pendingRequests++;\n          var coords = this._keyToCellCoords(key);\n          var bounds = this._cellCoordsToBounds(coords);\n          this._requestFeatures(bounds, key, requestCallback);\n        }\n      }\n    },\n\n    refresh: function(){\n      for(var key in this._activeCells){\n        var coords = this._keyToCellCoords(key);\n        var bounds = this._cellCoordsToBounds(coords);\n        this._requestFeatures(bounds, key);\n      }\n    },\n\n    _filterExistingFeatures: function (oldFrom, oldTo, newFrom, newTo) {\n      var layersToRemove = (oldFrom && oldTo) ? this._getFeaturesInTimeRange(oldFrom, oldTo) : this._currentSnapshot;\n      var layersToAdd = this._getFeaturesInTimeRange(newFrom, newTo);\n\n      if(layersToAdd.indexOf){\n        for (var i = 0; i < layersToAdd.length; i++) {\n          var shouldRemoveLayer = layersToRemove.indexOf(layersToAdd[i]);\n          if(shouldRemoveLayer >= 0){\n            layersToRemove.splice(shouldRemoveLayer, 1);\n          }\n        }\n      }\n\n      // schedule adding features until the next animation frame\n      EsriLeaflet.Util.requestAnimationFrame(L.Util.bind(function(){\n        this.removeLayers(layersToRemove);\n        this.addLayers(layersToAdd);\n      }, this));\n    },\n\n    _getFeaturesInTimeRange: function(start, end){\n      var ids = [];\n      var search;\n\n      if(this.options.timeField.start && this.options.timeField.end){\n        var startTimes = this._startTimeIndex.between(start, end);\n        var endTimes = this._endTimeIndex.between(start, end);\n        search = startTimes.concat(endTimes);\n      } else {\n        search = this._timeIndex.between(start, end);\n      }\n\n      for (var i = search.length - 1; i >= 0; i--) {\n        ids.push(search[i].id);\n      }\n\n      return ids;\n    },\n\n    _buildTimeIndexes: function(geojson){\n      var i;\n      var feature;\n      if(this.options.timeField.start && this.options.timeField.end){\n        var startTimeEntries = [];\n        var endTimeEntries = [];\n        for (i = geojson.length - 1; i >= 0; i--) {\n          feature = geojson[i];\n          startTimeEntries.push( {\n            id: feature.id,\n            value: new Date(feature.properties[this.options.timeField.start])\n          });\n          endTimeEntries.push( {\n            id: feature.id,\n            value: new Date(feature.properties[this.options.timeField.end])\n          });\n        }\n        this._startTimeIndex.bulkAdd(startTimeEntries);\n        this._endTimeIndex.bulkAdd(endTimeEntries);\n      } else {\n        var timeEntries = [];\n        for (i = geojson.length - 1; i >= 0; i--) {\n          feature = geojson[i];\n          timeEntries.push( {\n            id: feature.id,\n            value: new Date(feature.properties[this.options.timeField])\n          });\n        }\n\n        this._timeIndex.bulkAdd(timeEntries);\n      }\n    },\n\n    _featureWithinTimeRange: function(feature){\n      if(!this.options.from || !this.options.to){\n        return true;\n      }\n\n      var from = +this.options.from.valueOf();\n      var to = +this.options.to.valueOf();\n\n      if(typeof this.options.timeField === 'string'){\n        var date = +feature.properties[this.options.timeField];\n        return (date >= from) && (date <= to);\n      }\n\n      if(this.options.timeField.start &&  this.options.timeField.end){\n        var startDate = +feature.properties[this.options.timeField.start];\n        var endDate = +feature.properties[this.options.timeField.end];\n        return ((startDate >= from) && (startDate <= to)) || ((endDate >= from) && (endDate <= to));\n      }\n    },\n\n    /**\n     * Service Methods\n     */\n\n    authenticate: function(token){\n      this._service.authenticate(token);\n      return this;\n    },\n\n    metadata: function(callback, context){\n      this._service.metadata(callback, context);\n      return this;\n    },\n\n    query: function(){\n      return this._service.query();\n    },\n\n    addFeature: function(feature, callback, context){\n      this._service.addFeature(feature, function(error, response){\n        if(!error){\n          this.refresh();\n        }\n        if(callback){\n          callback.call(context, error, response);\n        }\n      }, this);\n      return this;\n    },\n\n    updateFeature: function(feature, callback, context){\n      return this._service.updateFeature(feature, function(error, response){\n        if(!error){\n          this.refresh();\n        }\n        if(callback){\n          callback.call(context, error, response);\n        }\n      }, this);\n    },\n\n    deleteFeature: function(id, callback, context){\n      return this._service.deleteFeature(id, function(error, response){\n        if(!error && response.objectId){\n          this.removeLayers([response.objectId], true);\n        }\n        if(callback){\n          callback.call(context, error, response);\n        }\n      }, this);\n    }\n  });\n\n  /**\n   * Temporal Binary Search Index\n   */\n\n  function BinarySearchIndex(values) {\n    this.values = values || [];\n  }\n\n  BinarySearchIndex.prototype._query = function(query){\n    var minIndex = 0;\n    var maxIndex = this.values.length - 1;\n    var currentIndex;\n    var currentElement;\n    var resultIndex;\n\n    while (minIndex <= maxIndex) {\n      resultIndex = currentIndex = (minIndex + maxIndex) / 2 | 0;\n      currentElement = this.values[Math.round(currentIndex)];\n      if (+currentElement.value < +query) {\n        minIndex = currentIndex + 1;\n      } else if (+currentElement.value > +query) {\n        maxIndex = currentIndex - 1;\n      } else {\n        return currentIndex;\n      }\n    }\n\n    return ~maxIndex;\n  };\n\n  BinarySearchIndex.prototype.sort = function(){\n    this.values.sort(function(a, b) {\n      return +b.value - +a.value;\n    }).reverse();\n    this.dirty = false;\n  };\n\n  BinarySearchIndex.prototype.between = function(start, end){\n    if(this.dirty){\n      this.sort();\n    }\n\n    var startIndex = this._query(start);\n    var endIndex = this._query(end);\n\n    if(startIndex === 0 && endIndex === 0){\n      return [];\n    }\n\n    startIndex = Math.abs(startIndex);\n    endIndex = (endIndex < 0) ? Math.abs(endIndex): endIndex + 1;\n\n    return this.values.slice(startIndex, endIndex);\n  };\n\n  BinarySearchIndex.prototype.bulkAdd = function(items){\n    this.dirty = true;\n    this.values = this.values.concat(items);\n  };\n\n})(EsriLeaflet);","EsriLeaflet.Layers.FeatureLayer = EsriLeaflet.Layers.FeatureManager.extend({\n\n  statics: {\n    EVENTS: 'click dblclick mouseover mouseout mousemove contextmenu popupopen popupclose'\n  },\n\n  options: {\n    cacheLayers: true\n  },\n\n  /**\n   * Constructor\n   */\n\n  initialize: function (url, options) {\n    EsriLeaflet.Layers.FeatureManager.prototype.initialize.call(this, url, options);\n\n    options = L.setOptions(this, options);\n\n    this._layers = {};\n    this._leafletIds = {};\n    this._key = 'c'+(Math.random() * 1e9).toString(36).replace('.', '_');\n  },\n\n  /**\n   * Layer Interface\n   */\n\n  onAdd: function(map){\n    map.on('zoomstart zoomend', function(e){\n      this._zooming = (e.type === 'zoomstart');\n    }, this);\n    return EsriLeaflet.Layers.FeatureManager.prototype.onAdd.call(this, map);\n  },\n\n  onRemove: function(map){\n    for (var i in this._layers) {\n      map.removeLayer(this._layers[i]);\n    }\n\n    return EsriLeaflet.Layers.FeatureManager.prototype.onRemove.call(this, map);\n  },\n\n  createNewLayer: function(geojson){\n    // @TODO Leaflet 0.8\n    //newLayer = L.GeoJSON.geometryToLayer(geojson, this.options);\n    return L.GeoJSON.geometryToLayer(geojson, this.options.pointToLayer, L.GeoJSON.coordsToLatLng, this.options);\n  },\n\n  /**\n   * Feature Managment Methods\n   */\n\n  createLayers: function(features){\n    for (var i = features.length - 1; i >= 0; i--) {\n\n      var geojson = features[i];\n\n      var layer = this._layers[geojson.id];\n      var newLayer;\n\n      if(layer && !this._map.hasLayer(layer)){\n        this._map.addLayer(layer);\n      }\n\n      if (layer && layer.setLatLngs) {\n        // @TODO Leaflet 0.8\n        //newLayer = L.GeoJSON.geometryToLayer(geojson, this.options);\n\n        var updateGeo = this.createNewLayer(geojson);\n        layer.setLatLngs(updateGeo.getLatLngs());\n      }\n\n      if(!layer){\n        // @TODO Leaflet 0.8\n        //newLayer = L.GeoJSON.geometryToLayer(geojson, this.options);\n\n        newLayer =  this.createNewLayer(geojson);\n        newLayer.feature = geojson;\n        newLayer.defaultOptions = newLayer.options;\n        newLayer._leaflet_id = this._key + '_' + geojson.id;\n\n        this._leafletIds[newLayer._leaflet_id] = geojson.id;\n\n        // bubble events from layers to this\n        // @TODO Leaflet 0.8\n        // newLayer.addEventParent(this);\n\n        newLayer.on(EsriLeaflet.Layers.FeatureLayer.EVENTS, this._propagateEvent, this);\n\n        // bind a popup if we have one\n        if(this._popup && newLayer.bindPopup){\n          newLayer.bindPopup(this._popup(newLayer.feature, newLayer), this._popupOptions);\n        }\n\n        if(this.options.onEachFeature){\n          this.options.onEachFeature(newLayer.feature, newLayer);\n        }\n\n        // cache the layer\n        this._layers[newLayer.feature.id] = newLayer;\n\n        // style the layer\n        this.resetStyle(newLayer.feature.id);\n\n        this.fire('createfeature', {\n          feature: newLayer.feature\n        });\n\n        // add the layer if it is within the time bounds or our layer is not time enabled\n        if(!this.options.timeField || (this.options.timeField && this._featureWithinTimeRange(geojson)) ){\n          this._map.addLayer(newLayer);\n        }\n      }\n    }\n  },\n\n  addLayers: function(ids){\n    for (var i = ids.length - 1; i >= 0; i--) {\n      var layer = this._layers[ids[i]];\n      if(layer){\n        this.fire('addfeature', {\n          feature: layer.feature\n        });\n        this._map.addLayer(layer);\n      }\n    }\n  },\n\n  removeLayers: function(ids, permanent){\n    for (var i = ids.length - 1; i >= 0; i--) {\n      var id = ids[i];\n      var layer = this._layers[id];\n      if(layer){\n        this.fire('removefeature', {\n          feature: layer.feature,\n          permanent: permanent\n        });\n        this._map.removeLayer(layer);\n      }\n      if(layer && permanent){\n        delete this._layers[id];\n      }\n    }\n  },\n\n  cellEnter: function(bounds, coords){\n    if(!this._zooming){\n      EsriLeaflet.Util.requestAnimationFrame(L.Util.bind(function(){\n        var cacheKey = this._cacheKey(coords);\n        var cellKey = this._cellCoordsToKey(coords);\n        var layers = this._cache[cacheKey];\n        if(this._activeCells[cellKey] && layers){\n          this.addLayers(layers);\n        }\n      }, this));\n    }\n  },\n\n  cellLeave: function(bounds, coords){\n    if(!this._zooming){\n      EsriLeaflet.Util.requestAnimationFrame(L.Util.bind(function(){\n        var cacheKey = this._cacheKey(coords);\n        var cellKey = this._cellCoordsToKey(coords);\n        var layers = this._cache[cacheKey];\n        var mapBounds = this._map.getBounds();\n        if(!this._activeCells[cellKey] && layers){\n          var removable = true;\n\n          for (var i = 0; i < layers.length; i++) {\n            var layer = this._layers[layers[i]];\n            if(layer && layer.getBounds && mapBounds.intersects(layer.getBounds())){\n              removable = false;\n            }\n          }\n\n          if(removable){\n            this.removeLayers(layers, !this.options.cacheLayers);\n          }\n\n          if(!this.options.cacheLayers && removable){\n            delete this._cache[cacheKey];\n            delete this._cells[cellKey];\n            delete this._activeCells[cellKey];\n          }\n        }\n      }, this));\n    }\n  },\n\n  /**\n   * Styling Methods\n   */\n\n  resetStyle: function (id) {\n    var layer = this._layers[id];\n\n    if(layer){\n      layer.options = layer.defaultOptions;\n      this.setFeatureStyle(layer.feature.id, this.options.style);\n    }\n\n    return this;\n  },\n\n  setStyle: function (style) {\n    this.options.style = style;\n    this.eachFeature(function (layer) {\n      this.setFeatureStyle(layer.feature.id, style);\n    }, this);\n    return this;\n  },\n\n  setFeatureStyle: function (id, style) {\n    var layer = this._layers[id];\n\n    if (typeof style === 'function') {\n      style = style(layer.feature);\n    }\n\n    /*trap inability to access default style options from MultiLine/MultiPolygon\n    please revisit at Leaflet 1.0*/\n    else if (!style && !layer.defaultOptions) {\n      var dummyPath = new L.Path();\n      style = L.Path.prototype.options;\n      style.fill = true; //not set by default\n    }\n\n    if (layer.setStyle) {\n      layer.setStyle(style);\n    }\n  },\n\n  /**\n   * Popup Methods\n   */\n\n  bindPopup: function (fn, options) {\n    this._popup = fn;\n    this._popupOptions = options;\n    for (var i in this._layers) {\n      var layer = this._layers[i];\n      var popupContent = this._popup(layer.feature, layer);\n      layer.bindPopup(popupContent, options);\n    }\n    return this;\n  },\n\n  unbindPopup: function () {\n    this._popup =  false;\n    for (var i in this._layers) {\n      var layer = this._layers[i];\n      if (layer.unbindPopup) {\n        layer.unbindPopup();\n      } else if (layer.getLayers) {\n        var groupLayers = layer.getLayers();\n        for (var j in groupLayers) {\n          var gLayer = groupLayers[j];\n          gLayer.unbindPopup();\n        }\n      }\n    }\n    return this;\n  },\n\n  /**\n   * Utility Methods\n   */\n\n  eachFeature: function (fn, context) {\n    for (var i in this._layers) {\n      fn.call(context, this._layers[i]);\n    }\n    return this;\n  },\n\n  getFeature: function (id) {\n    return this._layers[id];\n  },\n\n  // from https://github.com/Leaflet/Leaflet/blob/v0.7.2/src/layer/FeatureGroup.js\n  // @TODO remove at Leaflet 0.8\n  _propagateEvent: function (e) {\n    e.layer = this._layers[this._leafletIds[e.target._leaflet_id]];\n    e.target = this;\n    this.fire(e.type, e);\n  }\n});\n\nEsriLeaflet.FeatureLayer = EsriLeaflet.Layers.FeatureLayer;\n\nEsriLeaflet.Layers.featureLayer = function(url, options){\n  return new EsriLeaflet.Layers.FeatureLayer(url, options);\n};\n\nEsriLeaflet.featureLayer = function(url, options){\n  return new EsriLeaflet.Layers.FeatureLayer(url, options);\n};"]}